#!/usr/bin/env node

const canihaz = require('canihaz');
const path = require('path');
const fs = require('fs').promises;

const source = path.join(__dirname, '..', 'assets', 'diagrams');
const template = `
<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.1/css/all.min.css">
    <style>
      html, * {
        font-family: 'monaco';
      }

      .node {
        text-align: center;
      }
      
      i.fa {
        display: block;
        margin: 5px;
      }

      .edgeLabel:not(:empty) {
        padding: 0px 8px;
      }
    </style>
  </head>
  <body>
    <div id="container" class="mermaid"></div>
    <script id="api" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.0.0/mermaid.min.js" charset="utf-8"></script>
  </body>
</html>
`;

async function snapshot(page, file) {
  const chart = await fs.readFile(path.join(source, file), 'utf-8');
  const output = path.join(source, '..', `${ path.basename(file, '.mmd') }.png`);

  console.log(`Rendering ${ file }`);

  await page.setContent(template);
  await page.evaluate(chart => {
    window.mermaid.mermaidAPI.initialize({ theme: 'forest' });
    window.mermaid.mermaidAPI.render('id1', chart, svg => {
      document.getElementById('container').innerHTML = svg;
    });
  }, chart);

  const clip = await page.$eval('#container svg', svg => {
    const box = svg.getBoundingClientRect();
    return { x: box.left, y: box.top, width: box.width, height: box.height };
  });

  await page.screenshot({ path: output, clip, omitBackground: true });
}

console.log('Requesting availability of puppeteer, it will be installed if unavailable.'); // eslint-disable-line

canihaz({
  key: 'cliDependencies'
}).puppeteer(async function puppetmaster(error, puppeteer) {
  if (error) throw error;

  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  const diagrams = await fs.readdir(source);

  await page.setViewport({ width: 1920, height: 1080 });

  for (const file of diagrams) {
    if (path.extname(file) === '.mmd') await snapshot(page, file);
  }

  await browser.close();

  console.log('Chart images generated.'); // eslint-disable-line
});
